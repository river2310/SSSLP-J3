<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas 2025 - Tablero Jurisdiccional</title>
    
    <!-- Favicon del navegador -->
    <link rel="icon" type="image/png" href="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/favicons/logo-verde.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex flex-col md:flex-row min-h-screen no-print">
        <!-- Barra lateral -->
        <aside class="w-full md:w-72 bg-white border-r border-slate-200 p-6 flex flex-col">
            <div class="mb-10">
                <img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/hor-verde.png" alt="Logo" class="w-full h-auto object-contain">
                <div class="mt-2 pl-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">CUBOS 2025</span>
                </div>
            </div>

            <nav class="space-y-2 flex-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Categorías</p>
                <button onclick="changeTab('detecciones')" id="btn-detecciones" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-indigo-50 text-indigo-700 ring-1 ring-indigo-100 font-medium">
                    <i data-lucide="activity" class="w-5 h-5"></i> Detecciones
                </button>
                <button onclick="changeTab('tamiz')" id="btn-tamiz" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i> Tamizajes
                </button>
                <button onclick="changeTab('tratamientos')" id="btn-tratamientos" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium">
                    <i data-lucide="heart-pulse" class="w-5 h-5"></i> Tratamientos
                </button>
                <button onclick="changeTab('gam')" id="btn-gam" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-500 hover:bg-slate-50 font-medium">
                    <i data-lucide="users" class="w-5 h-5"></i> Grupos GAM
                </button>
            </nav>

            <div class="mt-10 p-4 bg-slate-900 rounded-2xl text-white">
                <p class="text-xs text-slate-400 mb-1">Estatus Global</p>
                <p id="corte-info" class="text-sm font-bold mb-3">Diciembre 2025</p>
                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div id="sidebar-progress" class="bg-emerald-400 h-full w-full"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 text-center uppercase font-bold">CIERRE CUBOS 2025</p>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                <div>
                    <h1 id="tab-title" class="text-3xl font-bold text-slate-800">Detecciones</h1>
                    <p class="text-slate-500 flex items-center gap-2 mt-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <span id="periodo-header">Cierre Anual: Enero - Diciembre 2025</span>
                    </p>
                </div>

                <div class="flex flex-wrap gap-4">
                    <button onclick="openReport()" class="flex items-center gap-2 bg-slate-800 text-white px-5 py-3 rounded-xl shadow-lg hover:bg-slate-700 transition-all font-semibold">
                        <i data-lucide="printer" class="w-5 h-5"></i> Generar Reporte
                    </button>

                    <select onchange="updateDashboard()" id="mes-select" class="bg-white border border-slate-200 rounded-xl px-4 py-3 font-medium outline-none">
                        <option value="ANUAL">Concentrado Anual</option>
                        <option value="0">Enero</option><option value="1">Febrero</option>
                        <option value="2">Marzo</option><option value="3">Abril</option>
                        <option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option>
                        <option value="8">Septiembre</option><option value="9">Octubre</option>
                        <option value="10">Noviembre</option><option value="11" selected>Diciembre</option>
                    </select>

                    <select onchange="updateDashboard()" id="unidad-select" class="bg-white border border-slate-200 rounded-xl px-4 py-3 font-medium outline-none min-w-[300px]">
                        <option value="GENERAL">JURISDICCIÓN SANITARIA (TOTAL)</option>
                        <optgroup label="Unidades Médicas">
                            <option>HOSPITAL COMUNITARIO SALINAS DE HIDALGO</option>
                            <option>HOSPITAL COMUNITARIO VILLA DE ARISTA</option>
                            <option>CENTRO DE SALD AHUALULCO</option>
                            <option>CENTRO DE SALUD TIERRA NUEVA</option>
                            <option>CENTRO DE SALUD VILLA DE ZARAGOZA</option>
                            <option>CENTRO DE SALUD VILLA DE REYES</option>
                            <option>CENTRO DE SALUD VILLA DE RAMOS</option>
                            <option>CENTRO DE SALUD VILLA DE ARRIAGA</option>
                            <option>CENTRO DE SALUD SANTO DOMINGO</option>
                            <option>CENTRO DE SALUD SAN FRANCISCO</option>
                            <option>CENTRO DE SALUD PORTEZUELO</option>
                            <option>CENTRO DE SALUD MONTE OBSCURO</option>
                            <option>CENTRO DE SALUD MEXQUITIC</option>
                            <option>CENTRO DE SALUD MARAVILLAS</option>
                            <option>VILLA HIDALGO</option>
                            <option>SANTA MARÍA DEL RÍO</option>
                            <option>TORTUGAS DE ARRIBA</option>
                            <option>SAN CRISTOBAL</option>
                            <option>SALITRAL DE CARRERA</option>
                            <option>MILPA GRANDE</option>
                            <option>LOS LOBOS</option>
                            <option>LA MODERNA</option>
                            <option>LA DULCITA</option>
                            <option>GUADIANA</option>
                            <option>EL POZO</option>
                            <option>EL CARRIZAL</option>
                            <option>EL CARMEN</option>
                            <option>UNIDAD MÉDICA MÓVIL SAN JOSÉ</option>
                            <option>UNIDAD MÉDICA MÓVIL LOS CHARCOS</option>
                            <option>UNIDAD MÉDICA MÓVIL LA PARADA DEL ZARCIDO</option>
                            <option>UNIDAD MÉDICA MÓVIL EMILIANO ZAPATA</option>
                            <option>UNIDAD MEDICA MOVIL CONTRERAS</option>
                            <option>UNIDAD MÉDICA MÓVIL BARRÍO DE SANTIAGO</option>
                        </optgroup>
                    </select>
                </div>
            </header>

            <!-- Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p id="label-prod-card" class="text-sm text-slate-500 font-medium mb-1">Productividad del Mes</p>
                    <span id="stat-total" class="text-4xl font-black text-slate-800">0</span>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p id="label-meta-card" class="text-sm text-slate-500 font-medium mb-1">Meta Programada</p>
                    <span id="stat-meta" class="text-4xl font-black text-slate-800">0</span>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                    <p id="label-cumpl-card" class="text-sm text-slate-500 font-medium mb-1">% Cumplimiento</p>
                    <div class="flex items-center gap-4">
                        <span id="stat-porcentaje" class="text-4xl font-black text-indigo-600">0%</span>
                        <div class="flex-1 bg-slate-100 h-3 rounded-full overflow-hidden">
                            <div id="progress-bar" class="bg-indigo-500 h-full w-0"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="charts-container" class="grid grid-cols-1 xl:grid-cols-2 gap-8"></div>
        </main>
    </div>

    <!-- Modal Reporte -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 no-print">
        <div class="bg-white w-full max-w-5xl max-h-[90vh] overflow-y-auto rounded-3xl shadow-2xl relative p-10">
            <div class="flex justify-between mb-8">
                <h2 class="text-2xl font-bold">Reporte de Cierre 2025</h2>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold">Imprimir / PDF</button>
                    <button onclick="closeReport()" class="bg-slate-200 px-4 py-2 rounded-lg font-bold">Cerrar</button>
                </div>
            </div>
            <div id="report-content"></div>
        </div>
    </div>
    <div id="print-container" class="print-only p-12 bg-white min-h-screen"></div>

    <script>
        lucide.createIcons();

        // ---------------------------------------------------------
        // BASE DE DATOS REAL (EXTRACTO DEL CSV)
        // Solo se muestran valores reales. Si no está aquí, es 0.
        // ---------------------------------------------------------
        const ACHIEVEMENTS_DB = {
            "CENTRO DE SALUD TIERRA NUEVA": {
                "DET01": [23,14,13,13,3,3,2,1,0,0,0,0],
                "DET03": [0,0,0,0,0,1,1,4,0,0,0,0],
                "DTE20": [6,3,1,2,1,2,0,1,0,0,0,0],
                "ADM08": [1,1,1,0,1,0,0,1,0,0,0,0],
                "AEC08": [1,1,1,0,1,0,0,1,0,0,0,0],
                "GAM01": [0,0,0,0,0,0,0,0,0,0,0,0],
                "GAM02": [0,0,0,0,0,0,0,0,0,0,0,0]
            },
            "VILLA HIDALGO": {
                "DET01": [22,10,9,9,10,0,11,11,4,6,6,0],
                "DET03": [6,6,2,5,1,0,6,4,2,5,3,1]
            },
            "UNIDAD MÉDICA MÓVIL SAN JOSÉ": {
                "DET03": [0,0,0,0,1,0,1,4,0,0,0,0],
                "DTE17": [0,0,0,0,1,0,0,0,0,0,0,0]
            },
            "CENTRO DE SALUD PORTEZUELO": {
                // Si la unidad no tiene datos en GAM, dejamos el objeto vacío o sin las llaves GAM
                "DET01": [0,0,0,0,0,0,0,0,0,0,0,0]
            }
            // Las demás unidades se asumen en 0 si no se agregan aquí explícitamente
        };

        const configBase = {
            detecciones: [
                { id: 'DET01', nombre: 'Detección Diabetes Mellitus', meta: 740 },
                { id: 'DET02', nombre: 'Detección Hipertensión Arterial', meta: 736 },
                { id: 'DET03', nombre: 'Detección Obesidad', meta: 748 },
                { id: 'DET04', nombre: 'Detección Dislipidemias', meta: 340 }
            ],
            tamiz: [
                { id: 'DTE20', nombre: 'Tamiz Síndrome de Caídas', meta: 360 },
                { id: 'DTE17', nombre: 'Tamiz Alteración de Memoria', meta: 480 },
                { id: 'DTE18', nombre: 'Tamiz Depresión', meta: 480 },
                { id: 'DTE19', nombre: 'Tamiz Incontinencia Urinaria', meta: 360 }
            ],
            tratamientos: [
                { id: 'ADM08', nombre: 'Ingresos a Tratamiento DM', meta: 135 },
                { id: 'AEC08', nombre: 'Ingresos a Tratamiento HTA', meta: 145 },
                { id: 'OBE01', nombre: 'Ingresos a Tratamiento Obesidad', meta: 70 }
            ],
            gam: [
                { id: 'GAM01', nombre: 'Grupos GAM-EC Activos', meta: 12 },
                { id: 'GAM02', nombre: 'Integrantes Acreditados', meta: 240 }
            ]
        };

        let currentTab = 'detecciones';
        const mesesShort = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        let chartInstances = [];
        let lastGeneratedData = [];

        function changeTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.replace('bg-indigo-50', 'text-slate-500');
                btn.classList.remove('text-indigo-700', 'ring-1', 'ring-indigo-100');
            });
            const activeBtn = document.getElementById(`btn-${tabId}`);
            activeBtn.classList.replace('text-slate-500', 'bg-indigo-50');
            activeBtn.classList.add('text-indigo-700', 'ring-1', 'ring-indigo-100');
            document.getElementById('tab-title').innerText = activeBtn.innerText.trim();
            updateDashboard();
        }

        // Función para obtener datos reales del DB o retornar ceros
        function getRealData(unidad, indicadorId) {
            if (unidad === 'GENERAL') {
                // Sumar todas las unidades
                let total = new Array(12).fill(0);
                Object.keys(ACHIEVEMENTS_DB).forEach(u => {
                    if (ACHIEVEMENTS_DB[u][indicadorId]) {
                        ACHIEVEMENTS_DB[u][indicadorId].forEach((val, i) => total[i] += val);
                    }
                });
                return total;
            }
            // Retornar datos de la unidad específica o ceros si no existe
            return ACHIEVEMENTS_DB[unidad] && ACHIEVEMENTS_DB[unidad][indicadorId] 
                ? ACHIEVEMENTS_DB[unidad][indicadorId] 
                : new Array(12).fill(0);
        }

        function updateDashboard() {
            const container = document.getElementById('charts-container');
            const selectedUnidad = document.getElementById('unidad-select').value;
            const mesValue = document.getElementById('mes-select').value;
            const isAnual = mesValue === 'ANUAL';
            const selectedMonthIdx = isAnual ? null : parseInt(mesValue);

            chartInstances.forEach(c => c.destroy());
            chartInstances = [];
            container.innerHTML = '';
            lastGeneratedData = [];

            let totalProd = 0;
            let totalMeta = 0;

            configBase[currentTab].forEach((ind, index) => {
                const realSeries = getRealData(selectedUnidad, ind.id);
                const valVista = isAnual ? realSeries.reduce((a, b) => a + b, 0) : realSeries[selectedMonthIdx];
                const metaVista = isAnual ? ind.meta : (ind.meta / 12);

                totalProd += valVista;
                totalMeta += metaVista;

                lastGeneratedData.push({ ...ind, logro: valVista, meta: Math.round(metaVista), series: realSeries });

                const div = document.createElement('div');
                div.className = "bg-white p-8 rounded-3xl border border-slate-200 shadow-sm";
                div.innerHTML = `<h3 class="font-bold text-slate-800 mb-4">${ind.nombre} <span class="text-xs text-slate-400">(${ind.id})</span></h3><div class="h-48"><canvas id="chart-${index}"></canvas></div>`;
                container.appendChild(div);

                const ctx = document.getElementById(`chart-${index}`).getContext('2d');
                chartInstances.push(new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: mesesShort,
                        datasets: [
                            { data: realSeries, borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.05)', pointRadius: isAnual ? 2 : realSeries.map((_, i) => i === selectedMonthIdx ? 6 : 2) },
                            { data: new Array(12).fill(ind.meta / 12), borderColor: '#cbd5e1', borderDash: [5, 5], pointRadius: 0 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                }));
            });

            document.getElementById('stat-total').innerText = totalProd.toLocaleString();
            document.getElementById('stat-meta').innerText = Math.round(totalMeta).toLocaleString();
            const pct = totalMeta > 0 ? Math.round((totalProd / totalMeta) * 100) : 0;
            document.getElementById('stat-porcentaje').innerText = pct + '%';
            document.getElementById('progress-bar').style.width = Math.min(pct, 100) + '%';
            
            // Textos de etiquetas
            document.getElementById('label-prod-card').innerText = isAnual ? "Productividad Anual" : "Productividad Mensual";
            document.getElementById('label-meta-card').innerText = isAnual ? "Meta Anual Prog." : "Meta Mensual Prog.";
            document.getElementById('label-mes').innerText = isAnual ? "Acumulado 2025" : nombresMeses[selectedMonthIdx] + " 2025";
        }

        const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function openReport() {
            const unidad = document.getElementById('unidad-select').value;
            const periodo = document.getElementById('mes-select').options[document.getElementById('mes-select').selectedIndex].text;
            let rows = lastGeneratedData.map(d => `<tr><td class="p-2 border">${d.id}</td><td class="p-2 border">${d.nombre}</td><td class="p-2 border text-center font-bold">${d.logro}</td><td class="p-2 border text-center">${d.meta}</td><td class="p-2 border text-right font-bold">${d.meta > 0 ? Math.round(d.logro/d.meta*100) : 0}%</td></tr>`).join('');
            
            const html = `
                <div class="flex justify-between items-center border-b-2 pb-4 mb-6">
                    <img src="https://d3dac9gdq8t83x.cloudfront.net/media/static/images/hor-verde.png" class="h-12">
                    <div class="text-right"><h2 class="font-bold">REPORTE DE METAS 2025</h2><p class="text-xs">${periodo}</p></div>
                </div>
                <p class="mb-4"><strong>Unidad:</strong> ${unidad}</p>
                <table class="w-full border-collapse text-sm mb-8">
                    <thead class="bg-slate-100"><tr><th class="p-2 border text-left">ID</th><th class="p-2 border text-left">Indicador</th><th class="p-2 border">Logro</th><th class="p-2 border">Meta</th><th class="p-2 border text-right">Avance</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="grid grid-cols-2 gap-10 text-center mt-12"><div class="border-t pt-2">Responsable Unidad</div><div class="border-t pt-2">Validación Jurisdiccional</div></div>
            `;
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('print-container').innerHTML = html;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function closeReport() { document.getElementById('report-modal').classList.add('hidden'); }
        window.onload = updateDashboard;
    </script>
</body>
</html>
